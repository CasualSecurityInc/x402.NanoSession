# x402.NanoSession Sequence Flow
# D2 Syntax

Client (Purse): {
  shape: person
}

Server (Middleware): {
  shape: square
}

Nano Network: {
  shape: cloud
}

Background Janitor: {
  shape: diamond
}

# 1. Initial Handshake
Client (Purse) -> Server (Middleware): GET /api/resource
Server (Middleware) -> Server (Middleware): Derive Pool Address & Tag
Server (Middleware) -- Client (Purse): 402 Payment Required 
  {tooltip: "Returns JSON/Headers: X-402-Address, X-402-Tag, Price_Raw"}

# 2. Payment Phase
Client (Purse) -> Client (Purse): Check Budget
Client (Purse) -> Client (Purse): Amount = Price + Tag
Client (Purse) -> Nano Network: Broadcast Send Block 
  {style: {stroke-dash: 3}}
Client (Purse) -> Client (Purse): Stores Block_Hash as Receipt

# 3. Verification Phase (Async)
Client (Purse) -> Server (Middleware): GET /api/resource 
  {label: "X-402-Payment-Block: <Hash>"}

Server (Middleware) -> Nano Network: Verify Block Confirmation
Nano Network -- Server (Middleware): Block Details (Confirmed)

Server (Middleware) -> Server (Middleware): Validation Logic 
  {tooltip: "Check Destination, Amount, Tag, and Idempotency"}

Server (Middleware) -- Client (Purse): 200 OK (Resource)

# 4. Lazy Settlement
Background Janitor -> Nano Network: Sweep funds (Pool -> Cold Wallet)
