# Sharding & Tagging Logic
direction: down

Inputs: {
  Session ID
  Request ID
  Price_Raw
}

Sharding Logic: {
  Server Master Seed
  PoolSize: "CONSTANT: POOL_SIZE"
  
  H1: Hash(Session ID)
  Idx: Pool Index = H1 % PoolSize
  
  Derive Address: {
    shape: process
  }
  Target Address
  
  Server Master Seed -> Derive Address
  Idx -> Derive Address
  Derive Address -> Target Address
}

Tagging Logic: {
  TagMod: "CONSTANT: TAG_MODULUS"
  
  H2: Hash(Request ID + Nonce)
  Tag: Tag = H2 % TagMod
  
  Calc: Final Amount = Price + Tag {
    shape: process
  }
}

Outputs: {
  Target Address
  Final Amount
}

# Connections
Inputs.Session ID -> Sharding Logic.H1
Inputs.Request ID -> Tagging Logic.H2
Inputs.Price_Raw -> Tagging Logic.Calc

Sharding Logic.Idx -> Sharding Logic.Derive Address

Tagging Logic.Tag -> Tagging Logic.Calc

# Linking to Outputs
Sharding Logic.Target Address -> Outputs.Target Address
Tagging Logic.Calc -> Outputs.Final Amount

# Styling
Outputs.Target Address.style.fill: "#d4f1f4"
Outputs.Final Amount.style.fill: "#d4f1f4"
