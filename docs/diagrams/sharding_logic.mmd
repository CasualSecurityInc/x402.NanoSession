flowchart TD
    subgraph Inputs
    SID[Session ID]
    RID[Request ID]
    P[Price_Raw]
    end

    subgraph "Sharding Logic"
    Seed[Server Master Seed]
    PoolSize[CONSTANT: POOL_SIZE]
    
    H1["Hash(Session ID)"]
    Idx["Pool Index = H1 % PoolSize"]
    
    Seed --> Derive
    Idx --> Derive
    Derive[Derive Address] --> Addr[Target Address]
    end

    subgraph "Tagging Logic"
    TagMod[CONSTANT: TAG_MODULUS]
    
    H2["Hash(Request ID + Nonce)"]
    Tag["Tag = H2 % TagMod"]
    
    Calc[Final Amount = Price + Tag]
    end
    
    SID --> H1
    RID --> H2
    P --> Calc
    Tag --> Calc

    subgraph Outputs
    Addr
    Amt[Final Amount]
    end
    
    style Addr fill:#d4f1f4,stroke:#333
    style Amt fill:#d4f1f4,stroke:#333
